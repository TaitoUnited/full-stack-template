images: [
  '$_IMAGE_REGISTRY/$_REPO_NAME/admin:$COMMIT_SHA',
  '$_IMAGE_REGISTRY/$_REPO_NAME/client:$COMMIT_SHA',
  '$_IMAGE_REGISTRY/$_REPO_NAME/graphql:$COMMIT_SHA',
  '$_IMAGE_REGISTRY/$_REPO_NAME/server:$COMMIT_SHA',
  '$_IMAGE_REGISTRY/$_REPO_NAME/www:$COMMIT_SHA'
]
timeout: 3000s

# If you want to grant outsiders access to your build logs, you may save
# the logs to a separate bucket determined by the logsBucket setting and
# grant the outsiders access to the bucket
# logsBucket: 'gs://my-builds' # TODO _TEMPLATE_DEFAULT for this also

substitutions:
  _REPO_NAME: server-template
  _IMAGE_REGISTRY: eu.gcr.io/$PROJECT_ID
  # NOTE: These are removed by 'taito project create'
  _TEMPLATE_DEFAULT_TAITO_IMAGE:
  _TEMPLATE_DEFAULT_ENVIRONMENTS:
  _TEMPLATE_DEFAULT_ORGANIZATION:
  _TEMPLATE_DEFAULT_ORGANIZATION_ABBR:
  _TEMPLATE_DEFAULT_GIT_ORGANIZATION:
  _TEMPLATE_DEFAULT_GIT_URL:
  _TEMPLATE_DEFAULT_SENTRY_ORGANIZATION:
  _TEMPLATE_DEFAULT_DOMAIN:
  _TEMPLATE_DEFAULT_DOMAIN_PROD:
  _TEMPLATE_DEFAULT_ZONE:
  _TEMPLATE_DEFAULT_ZONE_PROD:
  _TEMPLATE_DEFAULT_PROVIDER:
  _TEMPLATE_DEFAULT_PROVIDER_ORG_ID:
  _TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD:
  _TEMPLATE_DEFAULT_PROVIDER_REGION:
  _TEMPLATE_DEFAULT_PROVIDER_REGION_PROD:
  _TEMPLATE_DEFAULT_PROVIDER_ZONE:
  _TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD:
  _TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD:
  _TEMPLATE_DEFAULT_CONTAINER_REGISTRY:
  _TEMPLATE_DEFAULT_KUBERNETES:
  _TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX:
  _TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD:
  _TEMPLATE_DEFAULT_POSTGRES:
  _TEMPLATE_DEFAULT_POSTGRES_HOST:
  _TEMPLATE_DEFAULT_POSTGRES_HOST_PROD:
  _TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME:
  _TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT:

steps:

# NOTE: This first step is an optimization. We execute cancel with
# the google provided kubectl container instead of Taito CLI, because it
# doesn't need to be pulled before execution -> cancel executes immediately.
- id: manual-cancel
  name: 'gcr.io/cloud-builders/kubectl'
  entrypoint: 'bash'
  env:
    - branch_name=$BRANCH_NAME
    - commit_sha=$COMMIT_SHA
    - build_id=$BUILD_ID
    - full_repo_name=$_REPO_NAME
    - image_path=$_IMAGE_REGISTRY/$_REPO_NAME/server:$COMMIT_SHA
  args:
  - '-c'
  - |
    # NOTE: These are removed by 'taito project create'
    export template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    export template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    export template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    export template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    export template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    export template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    export template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    export template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    export template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    export template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    export template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    export template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    export template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    export template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    export template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    export template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    export template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    export template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    export template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    export template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    export template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    export template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    export template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    export template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    export template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    export template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    export template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    export template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

    export taito_target_env
    taito_target_env="$${branch_name}"
    if [[ "$${taito_target_env}" == "master" ]]; then
      taito_target_env="prod"
    fi
    export taito_env="$${taito_target_env}"
    source ./taito-config.sh

    # TODO: should be implemented in taito-cli plugin
    echo "- Get cluster credentials"
    if ! gcloud container clusters get-credentials "$${kubernetes_name}" \
      --zone "$${taito_provider_zone}"; then
      echo "ERROR: Get cluster credentials failed"
      exit 1
    fi

    echo "- Cancel all previous ongoing builds targetting the same branch"
    gcloud builds list --ongoing | \
      grep "$${full_repo_name}@$${branch_name}" | \
      grep -v "$${build_id}" | \
      cut -d ' ' -f 1 | \
      xargs -L1 gcloud builds cancel

    echo "- We ignore all fails during cancel (hence the last echo)"


# ----------------------- Taito CLI ----------------------------------

# Prepare build

- id: build-prepare
  waitFor: ['-']
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['build-prepare:$BRANCH_NAME', '$COMMIT_SHA']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

# Build artifacts in parallel

- id: artifact-build-admin
  waitFor: ['build-prepare']
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['artifact-build:admin:$BRANCH_NAME', '$COMMIT_SHA']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

- id: artifact-push-admin
  waitFor: ['artifact-build-admin']
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['artifact-push:admin:$BRANCH_NAME', '$COMMIT_SHA']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

- id: artifact-build-client
  waitFor: ['build-prepare']
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['artifact-build:client:$BRANCH_NAME', '$COMMIT_SHA']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

- id: artifact-push-client
  waitFor: ['artifact-build-client']
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['artifact-push:client:$BRANCH_NAME', '$COMMIT_SHA']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

- id: artifact-build-graphql
  waitFor: ['build-prepare']
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['artifact-build:graphql:$BRANCH_NAME', '$COMMIT_SHA']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

- id: artifact-push-graphql
  waitFor: ['artifact-build-graphql']
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['artifact-push:graphql:$BRANCH_NAME', '$COMMIT_SHA']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

- id: artifact-build-server
  waitFor: ['build-prepare']
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['artifact-build:server:$BRANCH_NAME', '$COMMIT_SHA']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

- id: artifact-push-server
  waitFor: ['artifact-build-server']
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['artifact-push:server:$BRANCH_NAME', '$COMMIT_SHA']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

- id: artifact-build-www
  waitFor: ['build-prepare']
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['artifact-build:www:$BRANCH_NAME', '$COMMIT_SHA']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

- id: artifact-push-www
  waitFor: ['artifact-build-www']
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['artifact-push:www:$BRANCH_NAME', '$COMMIT_SHA']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

# Deploy to target environment

- id: db-deploy
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['db-deploy:$BRANCH_NAME']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

- id: deployment-deploy
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['deployment-deploy:$BRANCH_NAME', '$COMMIT_SHA']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

# Test and verify deployment

- id: deployment-wait
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['deployment-wait:$BRANCH_NAME']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

- id: test
  waitFor: ['deployment-wait']
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['test:$BRANCH_NAME']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

- id: deployment-verify
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['deployment-verify:$BRANCH_NAME']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}

# Release build

- id: build-release
  name: '${_TEMPLATE_DEFAULT_TAITO_IMAGE}'
  args: ['build-release:$BRANCH_NAME']
  env:
    - taito_mode=ci
    # NOTE: These are removed by 'taito project create'
    - template_default_taito_image=${_TEMPLATE_DEFAULT_TAITO_IMAGE}
    - template_default_environments=${_TEMPLATE_DEFAULT_ENVIRONMENTS}
    - template_default_organization=${_TEMPLATE_DEFAULT_ORGANIZATION}
    - template_default_organization_abbr=${_TEMPLATE_DEFAULT_ORGANIZATION_ABBR}
    - template_default_git_organization=${_TEMPLATE_DEFAULT_GIT_ORGANIZATION}
    - template_default_git_url=${_TEMPLATE_DEFAULT_GIT_URL}
    - template_default_sentry_organization=${_TEMPLATE_DEFAULT_SENTRY_ORGANIZATION}
    - template_default_domain=${_TEMPLATE_DEFAULT_DOMAIN}
    - template_default_domain_prod=${_TEMPLATE_DEFAULT_DOMAIN_PROD}
    - template_default_zone=${_TEMPLATE_DEFAULT_ZONE}
    - template_default_zone_prod=${_TEMPLATE_DEFAULT_ZONE_PROD}
    - template_default_provider=${_TEMPLATE_DEFAULT_PROVIDER}
    - template_default_provider_org_id=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID}
    - template_default_provider_org_id_prod=${_TEMPLATE_DEFAULT_PROVIDER_ORG_ID_PROD}
    - template_default_provider_region=${_TEMPLATE_DEFAULT_PROVIDER_REGION}
    - template_default_provider_region_prod=${_TEMPLATE_DEFAULT_PROVIDER_REGION_PROD}
    - template_default_provider_zone=${_TEMPLATE_DEFAULT_PROVIDER_ZONE}
    - template_default_provider_zone_prod=${_TEMPLATE_DEFAULT_PROVIDER_ZONE_PROD}
    - template_default_monitoring_uptime_channels_prod=${_TEMPLATE_DEFAULT_MONITORING_UPTIME_CHANNELS_PROD}
    - template_default_container_registry=${_TEMPLATE_DEFAULT_CONTAINER_REGISTRY}
    - template_default_kubernetes=${_TEMPLATE_DEFAULT_KUBERNETES}
    - template_default_kubernetes_cluster_prefix=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX}
    - template_default_kubernetes_cluster_prefix_prod=${_TEMPLATE_DEFAULT_KUBERNETES_CLUSTER_PREFIX_PROD}
    - template_default_postgres=${_TEMPLATE_DEFAULT_POSTGRES}
    - template_default_postgres_host=${_TEMPLATE_DEFAULT_POSTGRES_HOST}
    - template_default_postgres_host_prod=${_TEMPLATE_DEFAULT_POSTGRES_HOST_PROD}
    - template_default_postgres_master_username=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_USERNAME}
    - template_default_postgres_master_password_hint=${_TEMPLATE_DEFAULT_POSTGRES_MASTER_PASSWORD_HINT}
